name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  #gcc12-basic-asan:
  #  runs-on: ubuntu-latest
  #  steps:
  #  - uses: actions/checkout@v4
  #  - uses: bazel-contrib/setup-bazel@0.8.2
  #    with:
  #      bazelisk-cache: true
  #      bazelisk-version: 1.19.0
  #      disk-cache: gcc12-basic-asan
  #      repository-cache: true
  #  - run: CC=gcc-12 bazel test --config asan ...

  #gcc12-basic-tsan:
  #  runs-on: ubuntu-latest
  #  steps:
  #  - uses: actions/checkout@v4
  #  - uses: bazel-contrib/setup-bazel@0.8.2
  #    with:
  #      bazelisk-cache: true
  #      bazelisk-version: 1.19.0
  #      disk-cache: gcc12-basic-tsan
  #      repository-cache: true
  #  - run: CC=gcc-12 bazel test --config tsan ...

  #gcc12-arenastring-asan:
  #  runs-on: ubuntu-latest
  #  steps:
  #  - uses: actions/checkout@v4
  #  - uses: bazel-contrib/setup-bazel@0.8.2
  #    with:
  #      bazelisk-cache: true
  #      bazelisk-version: 1.19.0
  #      disk-cache: gcc12-arenastring-asan
  #      external-cache: true
  #      repository-cache: true
  #  - run: CC=gcc-12 bazel test --config arenastring --config asan ...

  #gcc12-mutable-donated-string-asan:
  #  runs-on: ubuntu-latest
  #  steps:
  #  - uses: actions/checkout@v4
  #  - uses: bazel-contrib/setup-bazel@0.8.2
  #    with:
  #      bazelisk-cache: true
  #      bazelisk-version: 1.19.0
  #      disk-cache: gcc12-mutable-donated-string-asan
  #      external-cache: true
  #      repository-cache: true
  #  - run: CC=gcc-12 bazel test --config mutable-donated-string --config asan ...

  #clang14-basic-asan:
  #  runs-on: ubuntu-latest
  #  steps:
  #  - uses: actions/checkout@v4
  #  - uses: bazel-contrib/setup-bazel@0.8.2
  #    with:
  #      bazelisk-cache: true
  #      bazelisk-version: 1.19.0
  #      disk-cache: clang14-basic-asan
  #      repository-cache: true
  #  - run: CC=clang-14 bazel test --cxxopt=-stdlib=libc++ --linkopt=-stdlib=libc++ --config asan ...

  #clang14-basic-tsan:
  #  runs-on: ubuntu-latest
  #  steps:
  #  - uses: actions/checkout@v4
  #  - uses: bazel-contrib/setup-bazel@0.8.2
  #    with:
  #      bazelisk-cache: true
  #      bazelisk-version: 1.19.0
  #      disk-cache: clang14-basic-tsan
  #      repository-cache: true
  #  - run: CC=clang-14 bazel test --cxxopt=-stdlib=libc++ --linkopt=-stdlib=libc++ --config tsan ...

  #clang14-arenastring-asan:
  #  runs-on: ubuntu-latest
  #  steps:
  #  - uses: actions/checkout@v4
  #  - uses: bazel-contrib/setup-bazel@0.8.2
  #    with:
  #      bazelisk-cache: true
  #      bazelisk-version: 1.19.0
  #      disk-cache: clang14-arenastring-asan
  #      repository-cache: true
  #  - run: CC=clang-14 bazel test --cxxopt=-stdlib=libc++ --linkopt=-stdlib=libc++ --config arenastring --config asan ...

  #clang14-mutable-donated-string-asan:
  #  runs-on: ubuntu-latest
  #  steps:
  #  - uses: actions/checkout@v4
  #  - uses: bazel-contrib/setup-bazel@0.8.2
  #    with:
  #      bazelisk-cache: true
  #      bazelisk-version: 1.19.0
  #      disk-cache: clang14-mutable-donated-string-asan
  #      repository-cache: true
  #  - run: bazel test --action_env=CC=clang-14 --cxxopt=-stdlib=libc++ --linkopt=-stdlib=libc++ --config mutable-donated-string --config asan ...

  coverage:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: bazel-contrib/setup-bazel@0.8.2
      with:
        bazelisk-cache: true
        bazelisk-version: 1.19.0
    - uses: actions/cache@v4
      with:
        path: bazel-repo
        key: bazel-repo-${{hashFiles('WORKSPACE')}}
    - uses: actions/cache@v4
      with:
        path: bazel-disk
        key: bazel-disk-${{github.sha}}-coverage
    - run: bazel coverage --config ci --combined_report=lcov --instrumentation_filter='src/babylon,-src/babylon/reusable/patch' test:test_any
    - run: ls -l bazel-out/_coverage/
    - run: ls -l ~/.bazel
    - run: ls -l bazel-base
    - run: ls -l bazel-repo
    - run: ls -l bazel-disk
    - uses: coverallsapp/github-action@v2
      with:
        github-token: ${{github.token}}
        file: bazel-out/_coverage/_coverage_report.dat
        format: lcov
